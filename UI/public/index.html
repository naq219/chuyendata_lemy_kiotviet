<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiotViet Migration Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-placeholder {
      text-align: center;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .image-preview {
      text-align: center;
    }

    .btn-ncc-ship {
      background: #ff9800;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-ncc-ship:hover {
      background: #f57c00;
    }

    .btn-ncc-ship:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-change-status {
      background: #2196f3;
      color: white;
      padding: 8px16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- Copy Notification -->
    <div class="copy-notification" v-if="copyNotification">{{ copyNotification }}</div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" v-if="showConfirmModal" @click.self="cancelRemigrate">
      <div class="modal">
        <div class="modal-header">⚠️ Xác nhận Migrate Lại</div>
        <div class="modal-body">
          <p><strong>Bạn có chắc chắn muốn migrate lại đơn hàng này không?</strong></p>
          <p v-if="confirmModalOrder">
            Đơn #{{ confirmModalOrder.order_id }} - {{ confirmModalOrder.customer_name }}
          </p>
          <p style="color: #f44336; margin-top: 10px;">
            ⚠️ Hành động này sẽ:
            <br>• Xóa đơn hàng trên KiotViet
            <br>• Xóa thông tin mapping
            <br>• Tạo lại đơn hàng mới
          </p>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" @click="cancelRemigrate">Hủy</button>
          <button class="btn-confirm" @click="confirmRemigrate">Xác nhận</button>
        </div>
      </div>
    </div>

    <!-- NCC Ship Modal -->
    <div class="modal-overlay" v-if="showNccShipModal" @click.self="closeNccShipDialog">
      <div class="modal" @paste="handleImagePaste">
        <div class="modal-header">🚚 Chuyển NCC Ship</div>
        <div class="modal-body">
          <p v-if="nccShipOrder">
            Đơn #{{ nccShipOrder.order_id }} - {{ nccShipOrder.customer_name }}
          </p>

          <!-- Image Upload Area -->
          <div class="upload-area">
            <div v-if="!nccShipImagePreview" class="upload-placeholder">
              <div class="upload-icon">📷</div>
              <p>Kéo thả ảnh vào đây hoặc nhấn để chọn file</p>
              <p style="font-size: 0.9em; color: #666;">Hoặc nhấn Ctrl+V để paste ảnh</p>
              <input type="file" @change="handleImageUpload" accept="image/*" style="display: none;" ref="fileInput">
              <button class="btn-secondary" @click="$refs.fileInput.click()" style="margin-top: 10px;">
                📁 Chọn File
              </button>
            </div>
            <div v-else class="image-preview">
              <img :src="nccShipImagePreview" alt="Preview" style="max-width: 100%; max-height: 300px;">
              <button class="btn-cancel" @click="nccShipImage = null; nccShipImagePreview = null;"
                style="margin-top: 10px;">
                ❌ Xóa ảnh
              </button>
            </div>
          </div>

          <!-- NCC Order ID Input -->
          <div style="margin-top: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mã đơn NCC:</label>
            <input v-model="nccOrderId" type="text" placeholder="Nhập mã đơn NCC"
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ngày NCC xuất đơn:</label>
          <input v-model="nccOrderDate" type="date" placeholder="Nhập ngày"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          

        </div>
        <div class="modal-actions">
          <button class="btn-cancel" @click="closeNccShipDialog" :disabled="uploadingNccShip">Hủy</button>
          <button class="btn-confirm" @click="uploadNccShip" :disabled="uploadingNccShip">
            <span v-if="uploadingNccShip" class="loading-spinner"></span>
            {{ uploadingNccShip ? 'Đang upload...' : '📤 Upload' }}
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>🔄 KiotViet Migration Tool</h2>

      <div class="header-stats1">
        <span class="stat-value">Tổng Đơn: {{ totalOrders }} - chuyển Kiotviet: {{ migratedCount }}</span>
      </div>

      <div class="progress-bar">
        <div class="progress-bar-fill" :style="{ width: progressPercent + '%' }"></div>
      </div>

      <div class="controls">
        <div class="search-row">
          <input v-model="searchOrderIds" placeholder="Nhập order ID (ví dụ: 22323,443434,22223)" class="search-input"
            @keyup.enter="searchOrders">
          <button class="btn-primary" @click="searchOrders" :disabled="loading">
            <span v-if="loading" class="loading-spinner"></span>
            🔍 Tìm
          </button>
        </div>
        <div class="button-row">
          <button class="btn-primary" @click="loadOrders" :disabled="loading">
            <span v-if="loading" class="loading-spinner"></span>
            {{ loading ? 'Đang tải...' : '🔄 MGS' }}
          </button>
          <button class="btn-secondary" @click="showFacebookInfo = !showFacebookInfo"
            :class="{ active: showFacebookInfo }">
            {{ showFacebookInfo ? '🙈 Ẩn FB' : '👤 Hiện FB' }}
          </button>
          <button class="btn-primary" @click="downloadMapping" v-if="buttonsUnlocked">
            💾 Mapping
          </button>
        </div>
      </div>

      <div class="orders-list" v-if="orders.length > 0">
        <div v-for="order in orders" :key="order.order_id" class="order-item"
          :class="{ migrated: order.migrated, error: order.error }">
          <div class="order-header">
            <span class="order-id" @click="copyOrderInfo(order)" style="cursor: pointer;">📦 DHM{{ order.order_id
              }}</span> <span style="font-size: 0.9em; color: #1902ed;">{{ mapOrderStatus(order.order_status) }}</span>
            <span class="copy-icon" @click.stop="copyOrderDetailsToJson(order)" title="Copy chi tiết đơn hàng">📋</span>
            <span class="order-status" :class="`status-${order.status || 'errr'}`">
              {{ statusLabel(order.status) }}
            </span>
          </div>

          <div class="order-details">
            <div class="order-detail-item">
              <span class="order-detail-label">Khách Hàng:</span>
              {{ order.customer_name }} ({{ order.customer_phone }})
              <span v-if="showFacebookInfo && order.customer_facebook" class="facebook-info">
                - Facebook: {{ order.customer_facebook }}
              </span>
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Địa Chỉ:</span>
              {{ order.customer_address || 'Không có địa chỉ' }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Ghi Chú:</span>
              {{ (order.note || '') + ' ' + (order.note_xuatkho || '') || 'Không có ghi chú' }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Ngày Tạo:</span>
              {{ formatDate(order.date_created) }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Tổng Tiền:</span>
              {{ formatCurrency(order.total_amount) }}
            </div>
          </div>

          <div class="order-products" v-if="order.products">
            <strong>🛍️ Sản phẩm ({{ order.products.length }}):</strong>
            <div class="product-item" v-for="p in order.products" :key="p.product_id">
              • <span class="product-quantity">SL {{ p.quantity }}</span> - {{ p.product_name }} - {{
              formatCurrency(p.gia_ban) }}
            </div>
            <div class="product-item" v-if="order.products.length > 38">
              • ... và {{ order.products.length - 3 }} sản phẩm khác
            </div>
          </div>

          <div v-if="order.error" class="error-message">
            ❌ {{ order.error }}
          </div>

          <div v-if="order.migrated" class="success-message">
            ✅ Migrate thành công! KiotViet Order: {{ order.kiotvietOrderCode }}
          </div>

          <div class="order-actions">
            <!-- Migrate Button - Only show for non-migrated orders -->
            <button v-if="!order.migrated && buttonsUnlocked" class="btn-migrate" @click="migrateOrder(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Đang migrate...' : '▶️ Migrate' }}
            </button>

            <!-- Remigrate Button - Only show for migrated orders -->
            <button v-if="order.migrated && buttonsUnlocked" class="btn-remigrate" @click="showRemigrateConfirm(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Đang migrate lại...' : '🔄 Migrate Lại' }}
            </button>

            <!-- Change Status Button -->
            <button v-if="buttonsUnlocked" class="btn-change-status" @click="changeStatus(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Đang xử lý...' : '🔄 Chuyển Trạng Thái' }}
            </button>

            <!-- NCC Ship Button -->
            <button v-if="buttonsUnlocked" class="btn-ncc-ship" @click="openNccShipDialog(order)"
              :disabled="order.migrating || loading">
              🚚 Chuyển NCC Ship
            </button>

            <!-- Retry Button - Only show for errors -->
            <button v-if="order.error && !order.migrating" class="btn-retry" @click="migrateOrder(order)">
              🔁 Retry
            </button>
          </div>
        </div>
      </div>

      <div v-else class="empty-state">
        <div class="empty-state-icon">📭</div>
        <p>Chưa có đơn hàng nào. Nhấp "Tải Đơn Hàng" để bắt đầu.</p>
      </div>
    </div>
  </div>

  <!-- Load JavaScript -->
  <script src="js/api.service.js?v=6"></script>
  <script src="js/app.js?v=6"></script>
</body>

</html>