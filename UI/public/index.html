<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiotViet Migration - UI</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .orders-list {
      margin-top: 30px;
    }

    .order-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .order-item:hover {
      background: #fff;
      border-color: #4CAF50;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
    }

    .order-item.migrated {
      border-left: 4px solid #4CAF50;
      background: #f0f9f4;
    }

    .order-item.error {
      border-left: 4px solid #f44336;
      background: #ffebee;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .order-id {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }

    .order-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-migrating {
      background: #e7f3ff;
      color: #0066cc;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .order-details {
      font-size: 13px;
      color: #666;
      margin: 10px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .order-detail-item {
      padding: 5px 0;
    }

    .order-detail-label {
      font-weight: bold;
      color: #333;
    }

    .order-products {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #2196F3;
    }

    .product-item {
      font-size: 12px;
      color: #666;
      padding: 3px 0;
    }

    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .btn-migrate {
      background: #4CAF50;
      color: white;
    }

    .btn-migrate:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-migrate:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-retry {
      background: #FF9800;
      color: white;
    }

    .btn-retry:hover {
      background: #F57C00;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      color: #f44336;
      font-size: 12px;
      margin-top: 8px;
      padding: 8px;
      background: #ffebee;
      border-radius: 4px;
    }

    .success-message {
      color: #4CAF50;
      font-size: 12px;
      margin-top: 8px;
      padding: 8px;
      background: #f0f9f4;
      border-radius: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      background: #2196F3;
      color: white;
    }

    .btn-primary:hover {
      background: #0b7dda;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      background: #e0e0e0;
      color: #333;
    }

    .pagination button.active {
      background: #4CAF50;
      color: white;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-bar-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <h1>üîÑ KiotViet Migration Tool</h1>
      
      <div class="header-stats">
        <div class="stat">
          <div class="stat-value">{{ totalOrders }}</div>
          <div class="stat-label">T·ªïng ƒê∆°n H√†ng</div>
        </div>
        <div class="stat">
          <div class="stat-value">{{ migratedCount }}</div>
          <div class="stat-label">ƒê√£ Migrate</div>
        </div>
        <div class="stat">
          <div class="stat-value">{{ failedCount }}</div>
          <div class="stat-label">L·ªói</div>
        </div>
        <div class="stat">
          <div class="stat-value">{{ progressPercent }}%</div>
          <div class="stat-label">Ti·∫øn ƒê·ªô</div>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-bar-fill" :style="{ width: progressPercent + '%' }"></div>
      </div>

      <div class="controls">
        <button class="btn-primary" @click="loadOrders" :disabled="loading">
          <span v-if="loading" class="loading-spinner"></span>
          {{ loading ? 'ƒêang t·∫£i...' : 'üîÑ T·∫£i ƒê∆°n H√†ng' }}
        </button>
        <button class="btn-primary" @click="downloadMapping">
          üíæ T·∫£i Mapping JSON
        </button>
      </div>

      <div class="orders-list" v-if="orders.length > 0">
        <div 
          v-for="order in orders" 
          :key="order.order_id"
          class="order-item"
          :class="{ migrated: order.migrated, error: order.error }"
        >
          <div class="order-header">
            <span class="order-id">üì¶ ƒê∆°n #{{ order.order_id }}</span>
            <span class="order-status" :class="`status-${order.status || 'pending'}`">
              {{ statusLabel(order.status) }}
            </span>
          </div>

          <div class="order-details">
            <div class="order-detail-item">
              <span class="order-detail-label">Kh√°ch H√†ng:</span>
              {{ order.customer_name }} ({{ order.customer_phone }})
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Ng√†y T·∫°o:</span>
              {{ formatDate(order.date_created) }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">T·ªïng Ti·ªÅn:</span>
              {{ formatCurrency(order.total_amount) }}
            </div>
          </div>

          <div class="order-products" v-if="order.products">
            <strong>üõçÔ∏è S·∫£n ph·∫©m ({{ order.products.length }}):</strong>
            <div class="product-item" v-for="p in order.products.slice(0, 3)" :key="p.product_id">
              ‚Ä¢ {{ p.product_name }} x{{ p.quantity }} - {{ formatCurrency(p.gia_ban) }}
            </div>
            <div class="product-item" v-if="order.products.length > 3">
              ‚Ä¢ ... v√† {{ order.products.length - 3 }} s·∫£n ph·∫©m kh√°c
            </div>
          </div>

          <div v-if="order.error" class="error-message">
            ‚ùå {{ order.error }}
          </div>

          <div v-if="order.migrated" class="success-message">
            ‚úÖ Migrate th√†nh c√¥ng! KiotViet Order: {{ order.kiotvietOrderCode }}
          </div>

          <div class="order-actions">
            <button 
              v-if="!order.migrated"
              class="btn-migrate" 
              @click="migrateOrder(order)"
              :disabled="order.migrating || loading"
            >
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'ƒêang migrate...' : '‚ñ∂Ô∏è Migrate' }}
            </button>
            <button 
              v-if="order.error && !order.migrating"
              class="btn-retry" 
              @click="migrateOrder(order)"
            >
              üîÅ Retry
            </button>
          </div>
        </div>
      </div>

      <div v-else class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. Nh·∫•p "T·∫£i ƒê∆°n H√†ng" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          orders: [],
          loading: false,
          migratedCount: 0,
          failedCount: 0,
          mapping: { customers: {}, products: {}, orders: {} },
        };
      },

      computed: {
        totalOrders() {
          return this.orders.length;
        },
        progressPercent() {
          if (this.totalOrders === 0) return 0;
          return Math.round((this.migratedCount / this.totalOrders) * 100);
        },
      },

      methods: {
        async loadOrders() {
          this.loading = true;
          try {
            const response = await fetch('http://localhost:3000/api/orders');
            const result = await response.json();

            if (result.success) {
              this.orders = result.data.map(o => ({
                ...o,
                status: 'pending',
                migrated: false,
                migrating: false,
                error: null,
                products: [],
              }));

              // Load products for each order
              for (const order of this.orders) {
                await this.loadOrderProducts(order);
              }

              // Load existing mapping
              await this.loadMapping();
            } else {
              alert('L·ªói: ' + result.error);
            }
          } catch (error) {
            alert('L·ªói k·∫øt n·ªëi: ' + error.message);
          } finally {
            this.loading = false;
          }
        },

        async loadOrderProducts(order) {
          try {
            const response = await fetch(`http://localhost:3000/api/order-details/${order.order_id}`);
            const result = await response.json();
            if (result.success) {
              order.products = result.data;
            }
          } catch (error) {
            console.error('Failed to load products:', error);
          }
        },

        async migrateOrder(order) {
          order.status = 'migrating';
          order.migrating = true;
          order.error = null;

          try {
            const response = await fetch('http://localhost:3000/api/migrate-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId: order.order_id,
                customerId: order.customer_id,
                orderDetails: order.products,
              }),
            });

            const result = await response.json();

            if (result.success) {
              order.status = 'success';
              order.migrated = true;
              order.kiotvietOrderCode = result.data.kiotvietOrderCode;
              this.migratedCount++;
              await this.loadMapping();
            } else {
              order.status = 'error';
              order.error = result.error;
              this.failedCount++;
            }
          } catch (error) {
            order.status = 'error';
            order.error = error.message;
            this.failedCount++;
          } finally {
            order.migrating = false;
          }
        },

        async loadMapping() {
          try {
            const response = await fetch('http://localhost:3000/api/mapping');
            const result = await response.json();
            if (result.success) {
              this.mapping = result.data;
              this.migratedCount = Object.keys(this.mapping.orders).length;
            }
          } catch (error) {
            console.error('Failed to load mapping:', error);
          }
        },

        downloadMapping() {
          const dataStr = JSON.stringify(this.mapping, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `migration_mapping_${new Date().getTime()}.json`;
          link.click();
        },

        formatDate(date) {
          return new Date(date).toLocaleDateString('vi-VN', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
          });
        },

        formatCurrency(value) {
          return new Intl.NumberFormat('vi-VN', { 
            style: 'currency', 
            currency: 'VND' 
          }).format(value);
        },

        statusLabel(status) {
          const labels = {
            pending: '‚è≥ Ch∆∞a b·∫Øt ƒë·∫ßu',
            migrating: '‚è≥ ƒêang migrate',
            success: '‚úÖ Th√†nh c√¥ng',
            error: '‚ùå L·ªói',
          };
          return labels[status] || '‚è≥ Ch∆∞a bi·∫øt';
        },
      },

      mounted() {
        this.loadOrders();
      },
    }).mount('#app');
  </script>
</body>
</html>