<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiotViet Migration Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div id="app">
    <!-- Copy Notification -->
    <div class="copy-notification" v-if="copyNotification">{{ copyNotification }}</div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" v-if="showConfirmModal" @click.self="cancelRemigrate">
      <div class="modal">
        <div class="modal-header">âš ï¸ XÃ¡c nháº­n Migrate Láº¡i</div>
        <div class="modal-body">
          <p><strong>Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n migrate láº¡i Ä‘Æ¡n hÃ ng nÃ y khÃ´ng?</strong></p>
          <p v-if="confirmModalOrder">
            ÄÆ¡n #{{ confirmModalOrder.order_id }} - {{ confirmModalOrder.customer_name }}
          </p>
          <p style="color: #f44336; margin-top: 10px;">
            âš ï¸ HÃ nh Ä‘á»™ng nÃ y sáº½:
            <br>â€¢ XÃ³a Ä‘Æ¡n hÃ ng trÃªn KiotViet
            <br>â€¢ XÃ³a thÃ´ng tin mapping
            <br>â€¢ Táº¡o láº¡i Ä‘Æ¡n hÃ ng má»›i
          </p>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" @click="cancelRemigrate">Há»§y</button>
          <button class="btn-confirm" @click="confirmRemigrate">XÃ¡c nháº­n</button>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>ğŸ”„ KiotViet Migration Tool</h2>

      <div class="header-stats1">
        <span class="stat-value">Tá»•ng ÄÆ¡n: {{ totalOrders }} - chuyá»ƒn Kiotviet: {{ migratedCount }}</span>
      </div>

      <div class="progress-bar">
        <div class="progress-bar-fill" :style="{ width: progressPercent + '%' }"></div>
      </div>

      <div class="controls">
        <div class="search-row">
          <input v-model="searchOrderIds" placeholder="Nháº­p order ID (vÃ­ dá»¥: 22323,443434,22223)" class="search-input"
            @keyup.enter="searchOrders">
          <button class="btn-primary" @click="searchOrders" :disabled="loading">
            <span v-if="loading" class="loading-spinner"></span>
            ğŸ” TÃ¬m
          </button>
        </div>
        <div class="button-row">
          <button class="btn-primary" @click="loadOrders" :disabled="loading">
            <span v-if="loading" class="loading-spinner"></span>
            {{ loading ? 'Äang táº£i...' : 'ğŸ”„ MGS' }}
          </button>
          <button class="btn-secondary" @click="showFacebookInfo = !showFacebookInfo"
            :class="{ active: showFacebookInfo }">
            {{ showFacebookInfo ? 'ğŸ™ˆ áº¨n FB' : 'ğŸ‘¤ Hiá»‡n FB' }}
          </button>
          <button class="btn-primary" @click="downloadMapping" v-if="buttonsUnlocked">
            ğŸ’¾ Mapping
          </button>
        </div>
      </div>

      <div class="orders-list" v-if="orders.length > 0">
        <div v-for="order in orders" :key="order.order_id" class="order-item"
          :class="{ migrated: order.migrated, error: order.error }">
          <div class="order-header">
            <span class="order-id" @click="copyOrderInfo(order)" style="cursor: pointer;">ğŸ“¦ ÄÆ¡n #{{ order.order_id
              }}</span>
            <span class="copy-icon" @click.stop="copyOrderDetailsToJson(order)" title="Copy chi tiáº¿t Ä‘Æ¡n hÃ ng">ğŸ“‹</span>
            <span class="order-status" :class="`status-${order.status || 'pending'}`">
              {{ statusLabel(order.status) }}
            </span>
          </div>

          <div class="order-details">
            <div class="order-detail-item">
              <span class="order-detail-label">KhÃ¡ch HÃ ng:</span>
              {{ order.customer_name }} ({{ order.customer_phone }})
              <span v-if="showFacebookInfo && order.customer_facebook" class="facebook-info">
                - Facebook: {{ order.customer_facebook }}
              </span>
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Äá»‹a Chá»‰:</span>
              {{ order.customer_address || 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰' }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Ghi ChÃº:</span>
              {{ (order.note || '') + ' ' + (order.note_xuatkho || '') || 'KhÃ´ng cÃ³ ghi chÃº' }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">NgÃ y Táº¡o:</span>
              {{ formatDate(order.date_created) }}
            </div>
            <div class="order-detail-item">
              <span class="order-detail-label">Tá»•ng Tiá»n:</span>
              {{ formatCurrency(order.total_amount) }}
            </div>
          </div>

          <div class="order-products" v-if="order.products">
            <strong>ğŸ›ï¸ Sáº£n pháº©m ({{ order.products.length }}):</strong>
            <div class="product-item" v-for="p in order.products" :key="p.product_id">
              â€¢ <span class="product-quantity">SL {{ p.quantity }}</span> - {{ p.product_name }} - {{
              formatCurrency(p.gia_ban) }}
            </div>
            <div class="product-item" v-if="order.products.length > 38">
              â€¢ ... vÃ  {{ order.products.length - 3 }} sáº£n pháº©m khÃ¡c
            </div>
          </div>

          <div v-if="order.error" class="error-message">
            âŒ {{ order.error }}
          </div>

          <div v-if="order.migrated" class="success-message">
            âœ… Migrate thÃ nh cÃ´ng! KiotViet Order: {{ order.kiotvietOrderCode }}
          </div>

          <div class="order-actions">
            <!-- Migrate Button - Only show for non-migrated orders -->
            <button v-if="!order.migrated && buttonsUnlocked" class="btn-migrate" @click="migrateOrder(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Äang migrate...' : 'â–¶ï¸ Migrate' }}
            </button>

            <!-- Remigrate Button - Only show for migrated orders -->
            <button v-if="order.migrated && buttonsUnlocked" class="btn-remigrate" @click="showRemigrateConfirm(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Äang migrate láº¡i...' : 'ğŸ”„ Migrate Láº¡i' }}
            </button>

            <!-- Change Status Button -->
            <button v-if="buttonsUnlocked" class="btn-change-status" @click="changeStatus(order)"
              :disabled="order.migrating || loading">
              <span v-if="order.migrating" class="loading-spinner"></span>
              {{ order.migrating ? 'Äang xá»­ lÃ½...' : 'ğŸ”„ Chuyá»ƒn Tráº¡ng ThÃ¡i' }}
            </button>

            <!-- Retry Button - Only show for errors -->
            <button v-if="order.error && !order.migrating" class="btn-retry" @click="migrateOrder(order)">
              ğŸ” Retry
            </button>
          </div>
        </div>
      </div>

      <div v-else class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p>ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o. Nháº¥p "Táº£i ÄÆ¡n HÃ ng" Ä‘á»ƒ báº¯t Ä‘áº§u.</p>
      </div>
    </div>
  </div>

  <!-- Load JavaScript -->
  <script src="js/api.service.js?v=5"></script>
  <script src="js/app.js?v=5"></script>
</body>

</html>